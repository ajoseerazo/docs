---
title: "Webhooks"
description: "Receive real-time payment events via webhooks"
---

Webhooks allow you to receive real-time notifications about payment events. When a payment status changes, we'll send a POST request to your configured webhook URL with the event details.

## Webhook URL Configuration

Configure your webhook URL in your merchant dashboard or via the API. The URL must be publicly accessible and use HTTPS.

## Webhook Security

All webhook requests are signed using HMAC-SHA256 to ensure authenticity. The signature is included in the `X-Meru-Signature` header.

### Verifying Webhook Signatures

To verify that a webhook came from us, you should verify the signature using your webhook secret:

```js
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload, 'utf8')
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}

// Example usage
app.post('/webhook', (req, res) => {
  const signature = req.headers['x-meru-signature'];
  const payload = JSON.stringify(req.body);
  
  if (!verifyWebhookSignature(payload, signature, process.env.WEBHOOK_SECRET)) {
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // Process the webhook
  handleWebhookEvent(req.body);
  res.status(200).json({ received: true });
});
```

```python
import hmac
import hashlib

def verify_webhook_signature(payload, signature, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        payload.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)

# Example usage with Flask
@app.route('/webhook', methods=['POST'])
def webhook():
    signature = request.headers.get('X-Meru-Signature')
    payload = request.get_data(as_text=True)
    
    if not verify_webhook_signature(payload, signature, os.environ['WEBHOOK_SECRET']):
        return jsonify({'error': 'Invalid signature'}), 401
    
    # Process the webhook
    handle_webhook_event(request.json)
    return jsonify({'received': True}), 200
```

## Webhook Events

### Payment Status Changed

Sent when a payment status changes.

**Event Type:** `payment.status.changed`

```json
{
  "event": "payment.status.changed",
  "paymentId": "pay_3ddd0e5b-6276-4b48-b756-c1fcc9a2efd1",
  "orderId": "ORD-12345",
  "status": "paid",
  "amount": 99.99,
  "taxAmount": 8.99,
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### Payment Created

Sent when a new payment is created (when QR code payment is generated).

**Event Type:** `payment.created`

```json
{
  "event": "payment.created",
  "paymentId": "pay_3ddd0e5b-6276-4b48-b756-c1fcc9a2efd1",
  "orderId": "ORD-12345",
  "status": "created",
  "amount": 99.99,
  "taxAmount": 8.99,
  "expireAt": "2024-01-15T10:30:00Z",
  "timestamp": "2024-01-15T10:00:00Z"
}
```

## Payment Statuses

| Status | Description |
|--------|-------------|
| `created` | Payment has been created and QR code payment is active |
| `paid` | Payment has been successfully completed |
| `cancelled` | Payment was cancelled by the customer or merchant |
| `expired` | QR code payment has expired without payment |

## Webhook Headers

All webhook requests include the following headers:

| Header | Description |
|--------|-------------|
| `Content-Type` | `application/json` |
| `X-Meru-Signature` | HMAC-SHA256 signature of the request body |
| `X-Meru-Event` | The event type (e.g., `payment.status.changed`) |
| `X-Meru-Delivery-Id` | Unique identifier for this webhook delivery |

## Best Practices

### 1. Always Verify Signatures

Never process webhook events without verifying the signature. This prevents malicious requests from being processed.

### 2. Respond Quickly

Respond to webhook requests within 5 seconds. If you need more time to process the event, acknowledge receipt immediately and process asynchronously.

### 3. Handle Duplicates

Webhooks may be sent multiple times for the same event. Implement idempotency to handle duplicate events gracefully.

### 4. Log Webhook Events

Log all webhook events for debugging and audit purposes.

### 5. Error Handling

If your webhook endpoint returns a non-2xx status code, we'll retry the delivery with exponential backoff.

## Example Implementation

Here's a complete example of a webhook handler:

```js
const express = require('express');
const crypto = require('crypto');

const app = express();
app.use(express.json());

app.post('/webhook', (req, res) => {
  const signature = req.headers['x-meru-signature'];
  const eventType = req.headers['x-meru-event'];
  const deliveryId = req.headers['x-meru-delivery-id'];
  
  // Verify signature
  const payload = JSON.stringify(req.body);
  const expectedSignature = crypto
    .createHmac('sha256', process.env.WEBHOOK_SECRET)
    .update(payload, 'utf8')
    .digest('hex');
  
  if (!crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  )) {
    console.error('Invalid webhook signature');
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // Log the event
  console.log(`Received webhook: ${eventType}`, {
    deliveryId,
    paymentId: req.body.paymentId,
    orderId: req.body.orderId,
    status: req.body.status
  });
  
  // Process based on event type
  switch (eventType) {
    case 'payment.status.changed':
      handlePaymentStatusChanged(req.body);
      break;
    case 'payment.created':
      handlePaymentCreated(req.body);
      break;
    default:
      console.warn(`Unknown event type: ${eventType}`);
  }
  
  // Acknowledge receipt
  res.status(200).json({ received: true });
});

function handlePaymentStatusChanged(data) {
  // Update your database with the new payment status
  console.log(`Payment ${data.paymentId} status changed to ${data.status}`);
  
  if (data.status === 'paid') {
    // Trigger fulfillment process
    console.log(`Payment completed for order ${data.orderId}`);
  }
}

function handlePaymentCreated(data) {
  // Log the new payment creation
  console.log(`New payment created: ${data.paymentId} for order ${data.orderId}`);
}

app.listen(3000, () => {
  console.log('Webhook server listening on port 3000');
});
```

## Testing Webhooks

You can test your webhook endpoint using tools like ngrok to expose your local server:

```bash
# Install ngrok
npm install -g ngrok

# Expose your local server
ngrok http 3000

# Use the ngrok URL as your webhook endpoint
```

## Troubleshooting

### Common Issues

1. **Invalid Signature**: Ensure you're using the correct webhook secret and signature verification method.

2. **Timeout Errors**: Respond to webhooks within 5 seconds to avoid timeouts.

3. **Duplicate Events**: Implement idempotency using the `X-Meru-Delivery-Id` header.

4. **SSL Certificate Issues**: Ensure your webhook endpoint has a valid SSL certificate.

### Getting Help

If you're experiencing issues with webhooks:

1. Check the webhook delivery logs in your merchant dashboard
2. Verify your endpoint is publicly accessible
3. Ensure proper signature verification
4. Contact support with the `X-Meru-Delivery-Id` for specific failed deliveries 